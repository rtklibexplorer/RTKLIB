/*------------------------------------------------------------------------------
* rtklib unit test driver : SSR ionospheric functions
*-----------------------------------------------------------------------------*/
#include <stdio.h>
#include <math.h>
#include <assert.h>
#include "../../src/rtklib.h"

/* Test compute_legendre_polynomial function */
static void test_legendre_polynomial(void)
{
    double result;
    double tolerance = 1e-10;

    fprintf(stderr, "Testing compute_legendre_polynomial function...\n");

    /* Test basic Legendre polynomials P_n^m(x) */

    /* Various test cases for sectorial */
    struct legendre_test_cases {
        int n;
        int m;
        double u;
        double result;
    } TEST_CASES[] = {
        /** test cases built using the following Python code

        \verbatim
        from math import acos
        from scipy.special import sph_harm_y

        test_cases = [
            ( 1,  0, acos(0.5   )),
            ( 2,  1, acos(0.5   )),
            ( 3,  2, acos(0.1   )),
            ( 4,  1, acos(-0.3   )),
            ( 5,  3, acos(0.7   )),
            (10,  5, acos(0.9   )),
            (15, 15, acos(0.7071)),
            (20, 10, acos(0.1   )),
            (25,  5, acos(-0.9   ))
        ]

        for t in test_cases:
            result = sph_harm_y(*t, 0)
            print(f"{t} {result}")
        \endverbatim
        */
        {.n =  1, .m =  0, .u =  0.5   , .result =  0.24430125595145988},
        {.n =  2, .m =  1, .u =  0.5   , .result = -0.33452327177864455},
        {.n =  3, .m =  2, .u =  0.1   , .result =  0.10117656216689495},
        {.n =  4, .m =  1, .u = -0.3   , .result = -0.3208718590203563},
        {.n =  5, .m =  3, .u =  0.7   , .result = -0.429650274134896},
        {.n = 10, .m =  5, .u =  0.9   , .result = -0.2643099927773962},
        {.n = 15, .m = 15, .u =  0.7071, .result = -0.0032983285307971377},
        {.n = 20, .m = 10, .u =  0.1   , .result =  0.07522105324402778},
        {.n = 25, .m =  5, .u = -0.9   , .result =  0.3756544620315938},
    };
    size_t n_test_cases = sizeof(TEST_CASES) / sizeof(TEST_CASES[0]);

    for (int i = 0; i < n_test_cases; i ++) {
        const struct legendre_test_cases* tc = &TEST_CASES[i];
        assert (compute_legendre_polynomial(tc->n, tc->m, tc->u, &result) == 0);;
        assert (fabs(result - tc->result) < tolerance);
    }

    fprintf(stderr, "Testing compute_legendre_polynomial function (degraded cases)...\n");
    assert(compute_legendre_polynomial(-1, 0, 0.0, &result) < 0);
    assert(compute_legendre_polynomial(0, 1, 0.0, &result) < 0);
    assert(compute_legendre_polynomial(15, 15, 2.0, &result) < 0);
    assert(compute_legendre_polynomial(15, 15, 0.0, NULL) < 0);

}

static void test_compute_stec_method_to_compute_vtec(void) {

    /* spherical harmonic coefficients extracted from IONO00IGS1_BNC.txt, 2025 07 15 10 00 45.0 */
    const ssr_ion_t SSR_ION_IONO01IGS1 = {
        .ionlayers_sph_harm = {
            { .height_km = 450.0, .n_degree = 15, .m_order = 15,
              .cos_coeff = {2.1305e+01,  4.1100e+00, -7.3450e+00, -1.7800e+00,  1.8000e+00,
                            1.2500e+00, -3.4000e-01, -2.6000e-01,  1.9000e-01, -8.5000e-02,
                           -2.4000e-01,  2.0000e-01,  3.1000e-01, -2.0000e-01, -2.0000e-01,
                            1.7000e-01,  9.0850e+00, -3.3500e-01, -2.1150e+00, -3.7500e-01,
                            9.2500e-01,  3.2500e-01, -3.9000e-01, -8.0000e-02, -1.6000e-01,
                           -8.5000e-02,  6.0000e-02, -3.5000e-02,  3.5000e-02,  1.6000e-01,
                            7.0000e-02,  1.1900e+00, -6.7000e-01,  2.3000e-01, -3.5000e-01,
                            3.0000e-02,  7.5000e-02,  1.5000e-02, -1.3500e-01, -5.0000e-03,
                           -3.5000e-02, -1.0000e-01,  3.5000e-02,  6.0000e-02,  3.5000e-02,
                           -6.0500e-01,  3.8500e-01,  2.9000e-01, -3.4000e-01,  1.7500e-01,
                            2.0500e-01,  9.5000e-02,  1.5000e-02,  9.0000e-02, -8.0000e-02,
                            3.5000e-02,  7.5000e-02, -3.0000e-02,  1.6000e-01,  0.0000e+00,
                            5.5000e-02, -5.0000e-02, -6.0000e-02, -8.5000e-02, -1.0000e-02,
                            9.5000e-02,  6.0000e-02, -1.2000e-01,  5.0000e-02,  5.5000e-02,
                            2.0000e-02, -8.5000e-02, -2.0500e-01, -8.5000e-02, -4.0000e-02,
                            5.0000e-03,  3.5000e-02, -8.0000e-02, -1.0000e-01, -2.0000e-02,
                            9.5000e-02, -8.0000e-02,  6.5000e-02, -8.0000e-02, -4.0000e-02,
                           -3.0000e-02,  1.5500e-01,  1.0500e-01, -3.5000e-02,  0.0000e+00,
                           -3.0000e-02,  1.6500e-01, -5.0000e-02, -4.0000e-02, -1.0000e-02,
                           -5.5000e-02, -3.5000e-02,  4.5000e-02,  5.0000e-03, -5.5000e-02,
                            4.5000e-02, -1.5000e-01, -3.5000e-02, -5.0000e-03, -1.5000e-02,
                           -1.2500e-01,  6.5000e-02,  5.5000e-02,  9.0000e-02, -1.5000e-02,
                           -1.6000e-01,  5.5000e-02,  1.1000e-01, -5.5000e-02, -8.0000e-02,
                           -5.0000e-03,  2.0000e-02,  1.0000e-02, -1.0000e-02,  1.5000e-02,
                            3.0000e-02,  1.0000e-02, -5.5000e-02,  4.5000e-02, -9.5000e-02,
                            0.0000e+00, -2.0000e-02, -1.0000e-02,  2.0000e-02, -3.0000e-02,
                           -6.5000e-02,  2.5000e-02,  2.0000e-02,  6.5000e-02,  5.5000e-02,
                           -2.5000e-02},
              .sin_coeff = { 0.6  ,  2.17 , -0.595, -1.41 ,  0.13 ,  0.71 , -0.155, -0.105,
                             0.285,  0.01 , -0.3  ,  0.21 ,  0.225, -0.25 , -0.175, -1.14 ,
                             0.765,  0.15 , -0.57 , -0.25 ,  0.295, -0.07 , -0.015, -0.085,
                            -0.075,  0.   ,  0.03 , -0.045,  0.055,  0.84 ,  0.12 ,  0.09 ,
                            -0.165, -0.155, -0.03 ,  0.1  , -0.095, -0.105,  0.135, -0.155,
                            -0.04 ,  0.155,  0.32 , -0.38 ,  0.015, -0.12 , -0.05 ,  0.1  ,
                             0.185,  0.   , -0.005, -0.065,  0.04 ,  0.07 , -0.445, -0.185,
                             0.155,  0.215, -0.015, -0.18 , -0.02 , -0.005,  0.005, -0.085,
                             0.09 ,  0.12 ,  0.105, -0.075,  0.04 ,  0.   , -0.035, -0.08 ,
                            -0.03 , -0.05 ,  0.   ,  0.15 , -0.005,  0.   ,  0.04 ,  0.105,
                             0.015, -0.045,  0.02 ,  0.03 , -0.06 ,  0.065,  0.07 , -0.035,
                             0.   ,  0.03 ,  0.025, -0.02 ,  0.065, -0.015,  0.02 ,  0.03 ,
                             0.   , -0.03 ,  0.055,  0.11 , -0.03 ,  0.   , -0.055,  0.04 ,
                            -0.005, -0.015,  0.095,  0.005,  0.015,  0.055, -0.02 , -0.01 ,
                            -0.005,  0.02 ,  0.035, -0.015,  0.09 ,  0.015, -0.175, -0.085} }
        },
        .update_interval_s = 30,
        .n_layers = 1
    };

    const ssr_ion_t SSR_ION_IONO00CAS1 = {
        .ionlayers_sph_harm = {
            { .height_km = 450.0, .n_degree = 15, .m_order = 15,
              .cos_coeff = {2.2175e+01,  4.0100e+00, -7.8550e+00, -2.0250e+00,  1.8050e+00,
                            1.7350e+00, -2.8500e-01, -3.9000e-01,  0.0000e+00,  0.0000e+00,
                           -3.2000e-01,  2.1500e-01,  3.3500e-01, -3.0000e-01, -5.0000e-01,
                            2.8500e-01,  8.8750e+00, -2.9500e-01, -2.2650e+00, -5.0500e-01,
                            1.0400e+00,  2.4000e-01, -2.9000e-01, -1.8500e-01, -5.6000e-01,
                            1.5000e-02,  3.8500e-01, -3.5500e-01,  8.0000e-02,  3.1000e-01,
                            3.0500e-01,  1.2150e+00, -3.7000e-01,  4.4500e-01, -4.5000e-02,
                            2.4500e-01, -7.0000e-02, -1.2500e-01, -4.6000e-01, -3.8500e-01,
                           -3.3500e-01, -2.1500e-01,  2.0000e-01,  1.6000e-01,  1.5000e-01,
                           -4.0000e-01,  7.3000e-01,  2.5000e-02, -7.0500e-01,  4.7500e-01,
                            6.2500e-01,  1.9000e-01,  1.2500e-01,  1.5500e-01,  1.2000e-01,
                            8.0000e-02,  2.0000e-01, -1.0500e-01, -7.0000e-02, -2.4500e-01,
                           -1.3000e-01, -3.1500e-01, -6.0000e-02, -8.0000e-02,  3.0000e-02,
                            2.9500e-01,  2.3500e-01, -3.5500e-01,  9.5000e-02,  1.7000e-01,
                            1.4500e-01, -1.0000e-02, -7.9500e-01, -2.8000e-01,  2.5000e-02,
                           -4.5000e-02, -1.1000e-01, -5.0000e-02, -2.5500e-01, -8.0000e-02,
                            1.8000e-01, -1.8500e-01,  1.0000e-02, -7.0000e-02, -1.7000e-01,
                           -6.0000e-02,  3.5500e-01,  3.6000e-01, -2.0000e-02,  7.5000e-02,
                           -1.5000e-01,  2.7500e-01, -2.6500e-01, -1.6000e-01, -8.5000e-02,
                           -8.5000e-02, -1.2000e-01,  1.8000e-01,  3.0000e-02, -1.2500e-01,
                            2.2500e-01, -3.3000e-01, -1.8500e-01,  1.4500e-01, -2.0000e-02,
                           -4.9500e-01,  1.5000e-01,  2.0500e-01,  3.9500e-01, -1.0000e-02,
                           -6.2000e-01,  8.5000e-02,  3.2000e-01, -1.4500e-01, -2.8000e-01,
                           -7.5000e-02, -1.1500e-01,  6.0000e-02,  5.0000e-02,  9.5000e-02,
                            9.0000e-02, -1.0000e-02, -1.7500e-01,  2.0000e-01, -3.3500e-01,
                           -8.5000e-02, -2.5000e-02,  0.0000e+00,  6.0000e-02, -7.5000e-02,
                           -2.4000e-01,  4.5000e-02,  5.5000e-02,  3.0000e-01,  3.3500e-01,
                           -2.0000e-02},
              .sin_coeff = {0.32 ,  2.905, -0.445, -1.915,  0.035,  1.05 , -0.08 ,  0.   ,
                            0.52 ,  0.11 , -0.7  ,  0.055,  0.23 , -0.62 , -0.32 , -1.75 ,
                            0.715,  0.64 , -1.085, -0.475,  0.065, -0.315,  0.05 , -0.1  ,
                           -0.08 , -0.13 ,  0.15 , -0.03 ,  0.115,  0.72 ,  0.465,  0.485,
                           -0.28 , -0.22 , -0.15 ,  0.31 , -0.135, -0.375,  0.28 , -0.22 ,
                           -0.095,  0.215,  0.315, -0.365,  0.05 , -0.215, -0.075,  0.465,
                            0.4  ,  0.06 ,  0.03 , -0.085,  0.26 ,  0.205, -0.59 , -0.55 ,
                            0.1  ,  0.46 ,  0.01 , -0.315, -0.23 , -0.02 , -0.095, -0.28 ,
                            0.36 ,  0.375, -0.1  , -0.255,  0.1  ,  0.06 , -0.09 , -0.26 ,
                           -0.055, -0.235, -0.04 ,  0.165, -0.24 ,  0.14 ,  0.33 ,  0.3  ,
                            0.025, -0.15 , -0.025,  0.05 ,  0.06 ,  0.35 ,  0.27 , -0.025,
                           -0.095, -0.11 ,  0.155,  0.055,  0.37 ,  0.03 ,  0.1  ,  0.13 ,
                            0.09 , -0.22 ,  0.24 ,  0.39 ,  0.035,  0.055, -0.26 ,  0.185,
                           -0.03 , -0.15 ,  0.185,  0.02 ,  0.   ,  0.235,  0.005, -0.12 ,
                            0.01 ,  0.04 ,  0.125, -0.08 ,  0.38 ,  0.195, -0.53 , -0.3} }
        },
        .update_interval_s = 30,
        .n_layers = 1
    };

    int EPOCH_S = 15 * 3600 + 29 * 60 + 00;  // 2025 07 23 15 29 00.0

    double pos[3] = {0.0, 0.0, 0.0}; // Dummy position
    double azel[2] = {0.0, 90.0 * D2R}; // Zenith looking direction
    double stec_igs = 0.0;
    double stec_cas = 0.0;
    double re_km = 6371.0; // Earth radius in km

    fprintf(stderr, "Testing compute_stec_from_spherical_harmonics function (VTEC computation)...\n");

    // Initialize SSR ionospheric data with dummy values
    for (int lon = -180; lon < +180; lon += 10) {
        pos[1] = lon * D2R;
        for (int lat = -90; lat <= +90; lat += 10) {
            pos[0] = lat * D2R;
            assert(compute_stec_from_spherical_harmonics(&SSR_ION_IONO01IGS1, EPOCH_S, pos, azel, re_km, &stec_igs) == 0);
            assert(compute_stec_from_spherical_harmonics(&SSR_ION_IONO00CAS1, EPOCH_S, pos, azel, re_km, &stec_cas) == 0);
            assert(fabs(stec_igs - stec_cas) < 2.5); // Check if the STEC values are close enough
            // fprintf(stdout, "VTEC %i %lf %lf IONO01IGS1: %lf IONO00CAS1: %lf\n",
            //     EPOCH_S, pos[0] * R2D, pos[1] * R2D, stec_igs, stec_cas);
        }
    }


    fprintf(stderr, "compute_stec_from_spherical_harmonics passed.\n");

}


/* Main test function */
int main(void)
{

    test_legendre_polynomial();
    test_compute_stec_method_to_compute_vtec();

    printf("\n=== All SSR ion tests completed ===\n");
    return 0;
}
